# Deeper Into The Matrix

> Flaws in the matrix have been corrected, and now you must dive deeper to discover its secrets. Jack in at shell2017.picoctf.com:13265.

Hints:

> Sometimes a NULL pointer can be useful.

> The GOT is protected now - you'll have to find something else to attack.

We are not given source code this time, but when we open the binary in IDA we can notice that it looks almost identical to the one from `Enter The Matrix` challenge. Unfortunately the bug seems to be fixed, so we need to find something else.

What attracted my attention was that the program doesn't exit if malloc/calloc fails to allocate memory (as it did in previous challenges). What's more, hints say us that we need NULL pointer and we can easily make one if we try to allocate too much memory.

But what can null pointer be useful for? Maximum matrix size is 10000x10000 and it's array of floats, so we have to multiply this size by 4. `.got` section is much closer to null pointer than this size and it allows us to easily leak libc base address.

```
$ r2 /lib32/libc.so.6
[0x00019bc0]> ?v sym.system
0x3e3e0
[0x00019bc0]> ?v sym.setbuf
0x6b350
```

Unfortunately because of RELRO we can't patch `.got` section and we have to find another way to execute `system`.
Luckily I found great repository on github with pwn hints ( https://github.com/Naetw/CTF-pwn-tips#hijack-hook-function ) and it appears that we can hijack some hook functions from libc.

```
?v sym.__free_hook
0x1aa8b8
```

The next problem is that libc is probably loaded too far away from null pointer, so we'll need to create another matrix. We can edit its data pointer and use it to overwrite `__free_hook`. Last thing we have to do is to create one more matrix and put `system` parameter there. When you destroy the last matrix (the one with string in data) it will execute `free` function and in result `system`.

In order for exploit to work every time we need to free all the matrices BEFORE we overwrite `__free_hook` (probably there is no enough memory for `/bin/sh`)

[Final exploit](exploit.py)

The flag is `6271e0c26371220cc1c7166fda9f7d72`.
